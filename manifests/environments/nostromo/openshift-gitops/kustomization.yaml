apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - argocd-openshift-gitops.yaml
  - clusterrole.yaml

  - argocd.b4mad.emea.operate-first.cloud.yaml

  - bitnami-sealedsecret_rbac.yaml

  - gitops-application.yaml

configMapGenerator:
  - name: argocd-rbac-cm
    namespace: openshift-gitops
    behavior: replace
    files:
      - argocd-configs/policy.csv
      - argocd-configs/policy.default
generatorOptions:
  disableNameSuffixHash: true

patchesStrategicMerge:
  - |-
    apiVersion: argoproj.io/v1alpha1
    kind: ArgoCD
    metadata:
      name: openshift-gitops
      namespace: openshift-gitops
    spec:
      usersAnonymousEnabled: true
      statusBadgeEnabled: true
      server:
        insecure: true # so that our ingress can access the service via http (not https)
      rbac:
        policy: |
          g, system:cluster-admins, role:admin
          g, cluster-admins, role:admin
          g, b4mad-members, role:admin
        scopes: '[groups]'
